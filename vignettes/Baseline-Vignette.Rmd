---
title: "SHM: Quantifing selection pressures"
author: "Namita Gupta"
date: "`r Sys.Date()`"
output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{SHM Selection}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---
```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(dev='pdf')
```

BASELINe quantification of selection pressures calculates the posterior probability density function (PDF) based on observed mutations compared to expected based on the underlying targeting model. Selection is quantified via the following steps:

1. Load a Change-O tab-delimited database file
2. Calculate selection scores and group by relevant fields for comparison
3. Plot and compare selection scores of different groups of sequences

Load Change-O data
--------------------------------------------------------------------------------
A small example Change-O tab-delimited database file is included in the `shm` package. The example dataset consists of a subset of Ig sequencing data from an influenza vaccination study (Laserson et al., PNAS, 2014). The data have sequences from multiple time-points before and after the subject received an influenza vaccination. Quantifying selection requires the following fields (columns) to be present in the Change-O file: `SEQUENCE_IMGT`, and `GERMLINE_IMGT_D_MASK`.

```{r, eval=TRUE, warning=FALSE, message=FALSE}
library(alakazam)
library(shm)

# Load Change-O file
file <- system.file("extdata", "Influenza.tab", package="shm")
db <- readChangeoDb(file)
```

Calculate selection scores and group by relevant fields for comparison
--------------------------------------------------------------------------------
The function for calculating selection scores (`calcBaselinePdfs`) first collapses sequences by the `CLONE` column, if this column is provided. It then calculates the number of observed mutations and the expected frequency of mutations. The statistical framework used to test for selection can be specified using the `testStatistic` parameter. The underlying targeting model can be specified using the `targetingModel` parameter; in the example below, the default model (`HS5FModel`) is used. Selection is quantified separately for complementarity determining (CDR) and framework (FWR) regions. If Ig sequences are not gapped according to IMGT numbering, the region boundaries may be defined using the `regionDefinition` parameter. There are four built in region definitions in the `shm` package. `IMGT_V` is all regions in the V segment grouped as CDR or FWR, `IMGT_V_BY_REGIONS` is all CDR and FWR regions in the V segment treated as individual regions, `IMGT_V_NO_CDR3` (default value of `regionDefinition`) is all regions in the V segment excluding CDR3 grouped as CDR or FWR, and `IMGT_V_BY_REGIONS_NO_CDR3` is all regions in the V segment excluding CDR3 treated as individual regions. Column names for sequence and germline sequence can also be passed in as parameters if they differ from Change-O defaults.

Selection scores can be used to compare selection pressures between different samples. In the example Influenza dataset, the `BARCODE` field corresponds to samples taken at different timepoints before and after an influenza vaccination. Additionally, the `CPRIMER` field specifies the isotype of the sequence. The `groupBaseline` function convolutes the Baseline PDF of individual sequences (or clones) to get a combined PDF. The field(s) by which to group the sequences are specified with the `groupBy` parameter. The `summarizeBaseline` function takes the `Baseline` object returned by `groupBaseline` and summarizes it into a `data.frame` with grouping fields, number of sequences with observed mutations for each region, selection scores, 95% confidence intervals, and p-value. This summary `data.frame` can be subset to groups of interest and passed to `plotBaselineSummary` for visualization.

```{r, eval=TRUE, warning=FALSE, results="hide"}
# Calculate selection scores
baseline <- calcBaselinePdfs(db, testStatistic="focused", 
                             regionDefinition=IMGT_V_NO_CDR3, nproc=3)
db_sub <- subset(db, CPRIMER=="IGHA" & BARCODE %in% c("RL013", "RL018"))
baseline_pdf_sub <- calcBaselinePdfs(db_sub, testStatistic="focused", 
                                     regionDefinition=IMGT_V_NO_CDR3, nproc=3)

# Combine selection scores by sample barcode
baseline_one <- groupBaseline(baseline, groupBy=c("BARCODE"))
# Combine selection scores by sample barcode and isotype
baseline_two <- groupBaseline(baseline, groupBy=c("BARCODE", "CPRIMER"))
baseline_two_sub <- groupBaseline(baseline_pdf_sub, groupBy=c("BARCODE", "CPRIMER"))

# Subset to only two time-points
baseline_sub <- subset(summarizeBaseline(baseline_two), 
                       CPRIMER=="IGHA" & BARCODE %in% c("RL013", "RL018"))
```

Plot and compare selection scores of different groups of sequences
--------------------------------------------------------------------------------
`plotBaselineSummary` plots the mean and confidence interval of selection scores for the given groups. The `idColumn` parameter specifies the field that contains identifiers of the groups of sequences. If there is a secondary field by which the sequences are grouped, this can be specified using the `groupColumn`. This secondary grouping can have a user-defined color palette passed into `groupColors` or can be separated into facets by setting the `facetBy` parameter to "group". The `subsetRegions` parameter can be used to visualize selection of specific regions. Several examples utilizing these different parameters are provided below.

`plotBaseline` plots the full `Baseline` PDF of selection scores for the given groups. The parameters are the same as those for `plotBaselineSummary`, however rather than plotting the mean and confidence interval, the full density function is shown.

```{r, eval=TRUE, warning=FALSE}
# Plot mean and confidence interval by time-point
plotBaselineSummary(baseline_one, "BARCODE")
```
```{r, eval=TRUE, warning=FALSE, fig.width=10}
# Also group selection scores by isotype
plotBaselineSummary(baseline_two, "BARCODE", "CPRIMER")
# Reorder and recolor isotype groups
group_colors <- c("IGHM"="darkorchid", "IGHD"="firebrick", 
                  "IGHG"="seagreen", "IGHA"="steelblue")
plotBaselineSummary(baseline_two, "BARCODE", "CPRIMER", groupColors=group_colors)
# Only visualize selection scores for CDR
plotBaselineSummary(baseline_two, "BARCODE", "CPRIMER", subsetRegions="CDR")
```
```{r, eval=TRUE, warning=FALSE, fig.width=8.5}
# Group by CDR/FWR and facet by isotype
plotBaselineSummary(baseline_two, "BARCODE", "CPRIMER", facetBy="group")
```
```{r, eval=TRUE, warning=FALSE}
# Plot subset of data
plotBaselineSummary(baseline_sub, "BARCODE", "CPRIMER", groupColors=group_colors)

# Plot selection PDFs of subset of data
plotBaseline(baseline_two_sub, "BARCODE", "CPRIMER", groupColors=group_colors)
```